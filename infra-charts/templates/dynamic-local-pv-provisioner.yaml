{{ if .Values.storagelocalstaticprovisioner.required }}
---
apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: dynamic-local-pv-provisioner
  namespace: kube-system
spec:
  template:
    metadata:
      labels:
        app: pv-test
    spec:
      containers:
      - name: pv-test
        image: {{ .Values.dynamiclocalpvprovisioner.image_name }}
        imagePullPolicy: IfNotPresent
        command: [ "/executor", "--storagepath=/mnt/sig_storage" ]
        volumeMounts:
        - name: sig-storage-mount
          mountPath: /mnt/sig_storage
          mountPropagation: Bidirectional
        - name: fstab
          mountPath: /rootfs/fstab
        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        securityContext:
          privileged: true
          capabilities:
              add:
                - SYS_ADMIN
      volumes:
      - name: sig-storage-mount
        hostPath:
          path: {{ .Values.dynamiclocalpvprovisioner.local_storage_dir }}
      - name: fstab
        hostPath:
          path: /etc/fstab
      nodeSelector:
        nodename: caas_master1
      serviceAccountName: dynamic-pv
{{ end }}
